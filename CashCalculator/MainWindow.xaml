<Window x:Class="CashCalculator.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Cash Calculator beta 0.1"
        Height="625" Width="420"
        ResizeMode="CanMinimize"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource WindowBackgroundBrush}"
        Foreground="{DynamicResource WindowForegroundBrush}">

  <!-- РЕСУРСЫ  -->
  <Window.Resources>
    <!-- Палитра -->
    <SolidColorBrush x:Key="WindowBackgroundBrush"                 Color="#FFF0F0F0"/>
    <SolidColorBrush x:Key="WindowForegroundBrush"                 Color="#FF1E1E1E"/>
    <SolidColorBrush x:Key="DataGridRowBackgroundBrush"            Color="#FFFFFFFF"/>
    <SolidColorBrush x:Key="DataGridAlternationRowBackgroundBrush" Color="#FFF7F7F7"/>
    <SolidColorBrush x:Key="DataGridBorderBrush"                   Color="#FFCCCCCC"/>
    <SolidColorBrush x:Key="AccentBrush"                           Color="#FF4F94CD"/>

    <!-- DataGrid-стили (сокращённо) -->
    <Style x:Key="NiceGrid" TargetType="DataGrid">
      <Setter Property="AutoGenerateColumns" Value="False"/>
      <Setter Property="HeadersVisibility"    Value="Column"/>
      <Setter Property="GridLinesVisibility"  Value="None"/>
      <Setter Property="AlternationCount"     Value="2"/>
      <Setter Property="RowBackground"        Value="{StaticResource DataGridRowBackgroundBrush}"/>
      <Setter Property="AlternatingRowBackground" Value="{StaticResource DataGridAlternationRowBackgroundBrush}"/>
      <Setter Property="RowHeight"            Value="28"/>
      <Setter Property="FontSize"             Value="14"/>
      <Setter Property="BorderBrush"          Value="{StaticResource DataGridBorderBrush}"/>
      <Setter Property="BorderThickness"      Value="1"/>
      <Setter Property="SelectionMode"        Value="Single"/>
      <Setter Property="SelectionUnit"        Value="FullRow"/>
    </Style>

    <Style x:Key="NiceHeader" TargetType="DataGridColumnHeader">
      <Setter Property="Background"  Value="{StaticResource DataGridBorderBrush}"/>
      <Setter Property="Foreground"  Value="{StaticResource WindowForegroundBrush}"/>
      <Setter Property="FontWeight"  Value="Bold"/>
      <Setter Property="HorizontalContentAlignment" Value="Center"/>
      <Setter Property="FontSize"    Value="14"/>
      <Setter Property="Padding"     Value="5"/>
      <Setter Property="BorderThickness" Value="0,0,0,1"/>
      <Setter Property="BorderBrush" Value="{StaticResource DataGridBorderBrush}"/>
    </Style>

    <Style x:Key="NiceCell" TargetType="DataGridCell">
      <Setter Property="Padding"                    Value="5"/>
      <Setter Property="HorizontalContentAlignment" Value="Center"/>
      <Setter Property="FontSize"                   Value="14"/>
    </Style>

    <!-- Плоская кнопка -->
    <Style x:Key="FlatButton" TargetType="Button">
      <Setter Property="OverridesDefaultStyle" Value="True"/>
      <Setter Property="Background"            Value="Transparent"/>
      <Setter Property="BorderBrush"           Value="Transparent"/>
      <Setter Property="BorderThickness"       Value="0"/>
      <Setter Property="Cursor"                Value="Hand"/>
      <Setter Property="Opacity"               Value="1"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="Button">
            <ContentPresenter HorizontalAlignment="Center"
                              VerticalAlignment="Center"/>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
      <Style.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
          <Setter Property="Opacity" Value="0.8"/>
        </Trigger>
        <Trigger Property="IsPressed" Value="True">
          <Setter Property="Opacity" Value="0.6"/>
        </Trigger>
      </Style.Triggers>
    </Style>

    <!-- Плоский ToggleButton -->
    <Style x:Key="FlatToggleButton" TargetType="ToggleButton">
      <Setter Property="OverridesDefaultStyle" Value="True"/>
      <Setter Property="Background"            Value="Transparent"/>
      <Setter Property="BorderBrush"           Value="Transparent"/>
      <Setter Property="BorderThickness"       Value="0"/>
      <Setter Property="Cursor"                Value="Hand"/>
      <Setter Property="Opacity"               Value="1"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="ToggleButton">
            <ContentPresenter HorizontalAlignment="Center"
                              VerticalAlignment="Center"/>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
      <Style.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
          <Setter Property="Opacity" Value="0.8"/>
        </Trigger>
        <Trigger Property="IsPressed" Value="True">
          <Setter Property="Opacity" Value="0.6"/>
        </Trigger>
        <Trigger Property="IsChecked" Value="True">
          <Setter Property="Opacity" Value="0.6"/>
        </Trigger>
      </Style.Triggers>
    </Style>

    <!-- Крупная кнопка циферблата -->
    <Style x:Key="NumpadButton" TargetType="Button" BasedOn="{StaticResource FlatButton}">
      <Setter Property="Width"           Value="50"/>
      <Setter Property="Height"          Value="50"/>
      <Setter Property="FontSize"        Value="22"/>
      <Setter Property="Background"      Value="{StaticResource WindowBackgroundBrush}"/>
      <Setter Property="BorderBrush"     Value="{StaticResource DataGridBorderBrush}"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="Button">
            <Border Background="{TemplateBinding Background}"
                    BorderBrush="{TemplateBinding BorderBrush}"
                    BorderThickness="{TemplateBinding BorderThickness}"
                    CornerRadius="8">
              <ContentPresenter HorizontalAlignment="Center"
                                VerticalAlignment="Center"/>
            </Border>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>

    <!-- Коллекция с фильтром -->
    <CollectionViewSource x:Key="DenomsViewSource" Filter="DenomsFilter"/>
  </Window.Resources>

  <!-- UI  -->
  <Grid>
    <TabControl>
      <!-- ===== Calculator ===== -->
      <TabItem Header="Calculator">
        <DockPanel Margin="10" LastChildFill="False">
          <!-- Таблица номиналов -->
          <Border x:Name="DenomBorder" CornerRadius="8" Background="{StaticResource WindowBackgroundBrush}"
                  BorderBrush="{StaticResource DataGridBorderBrush}" BorderThickness="1"
                  Margin="0 0 0 10" DockPanel.Dock="Top">
            <DataGrid x:Name="DenomsGrid"
                      Style="{StaticResource NiceGrid}"
                      ColumnHeaderStyle="{StaticResource NiceHeader}"
                      CellStyle="{StaticResource NiceCell}"
                      Background="Transparent"
                      CanUserAddRows="False"
                      ItemsSource="{Binding Source={StaticResource DenomsViewSource}}"
                      CellEditEnding="DenomsGrid_CellEditEnding"
                      PreviewTextInput="DataGrid_PreviewTextInput"
                      PreviewMouseLeftButtonDown="DenomsGrid_PreviewMouseLeftButtonDown">
              <DataGrid.Columns>
                <DataGridTemplateColumn Header="" Width="Auto">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding StatusGlyph}"
                                 Foreground="{Binding StatusBrush}"
                                 FontSize="16"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Номинал, ₽" Binding="{Binding Value}" Width="*" IsReadOnly="True"/>
                <DataGridTextColumn Header="Кол-во" Binding="{Binding Amount,Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}" Width="*"/>
              </DataGrid.Columns>
            </DataGrid>
          </Border>

          <!-- Таблица итогов -->
          <Border x:Name="SummaryBorder" CornerRadius="8" Background="{StaticResource WindowBackgroundBrush}"
                  BorderBrush="{StaticResource DataGridBorderBrush}" BorderThickness="1"
                  Margin="0 0 0 10" DockPanel.Dock="Top">
            <DataGrid x:Name="SummaryGrid"
                      Style="{StaticResource NiceGrid}"
                      ColumnHeaderStyle="{StaticResource NiceHeader}"
                      CellStyle="{StaticResource NiceCell}"
                      Background="Transparent"
                      CanUserAddRows="False"
                      AutoGenerateColumns="False"
                      CellEditEnding="SummaryGrid_CellEditEnding"
                      PreviewTextInput="DataGrid_PreviewTextInput">
              <DataGrid.Columns>
                <DataGridTemplateColumn Header="" Width="Auto">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding StatusGlyph}"
                                 Foreground="{Binding StatusBrush}"
                                 FontSize="16"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Итого, ₽" Binding="{Binding Description}" Width="0.8*" IsReadOnly="True"/>
                <DataGridTextColumn Header="" Binding="{Binding Value,Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}" Width="*"/>
              </DataGrid.Columns>
            </DataGrid>
          </Border>

          <!-- Copy / Clean / Touch -->
          <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" HorizontalAlignment="Center" Margin="0 0 0 10">
            <Border CornerRadius="8" Background="{StaticResource WindowBackgroundBrush}"
                    BorderBrush="{StaticResource DataGridBorderBrush}" BorderThickness="1"
                    Padding="2" Margin="0 0 10 0">
              <Button Style="{StaticResource FlatButton}" Content="📋" Width="30" Height="30" Click="CopyReport_Click"/>
            </Border>
            <Border CornerRadius="8" Background="{StaticResource WindowBackgroundBrush}"
                    BorderBrush="{StaticResource DataGridBorderBrush}" BorderThickness="1"
                    Padding="2" Margin="0 0 10 0">
              <Button Style="{StaticResource FlatButton}" Content="🧹" Width="30" Height="30" Click="Clean_Click"/>
            </Border>
            <Border CornerRadius="8" Background="{StaticResource WindowBackgroundBrush}"
                    BorderBrush="{StaticResource DataGridBorderBrush}" BorderThickness="1" Padding="2">
              <ToggleButton x:Name="TouchModeButton" Style="{StaticResource FlatToggleButton}"
                            Content="🔢" Width="30" Height="30"
                            Checked="TouchModeButton_Checked"
                            Unchecked="TouchModeButton_Unchecked"
                            ToolTip="Touch Input"/>
            </Border>
          </StackPanel>

          <TextBlock DockPanel.Dock="Bottom" Text="© 2025 Kremenchugskaya Team"
                     FontSize="10" Foreground="{StaticResource DataGridBorderBrush}" HorizontalAlignment="Center"/>
        </DockPanel>
      </TabItem>

      <!-- ===== Settings ===== -->
      <TabItem Header="Settings">
        <ScrollViewer>
          <StackPanel Margin="10">
            <TextBlock FontWeight="Bold" FontSize="14" Margin="0 0 0 10" Text="Отображать номиналы"/>
            <ItemsControl ItemsSource="{Binding DenominationFilters}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <CheckBox Content="{Binding Value, StringFormat='{}{0}₽'}"
                            IsChecked="{Binding IsVisible}" Margin="0 0 0 5"/>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
            
            <!-- Инструкция -->
            <Separator Margin="0 15 0 15"/>
            <TextBlock FontWeight="Bold" FontSize="14"
                       Margin="0 0 0 10"
                       Text="Инструкция"/>

            <StackPanel>
              <TextBlock Text="📋 — скопировать отчёт в буфер обмена"
                         Margin="0 0 0 4"/>
              <TextBlock Text="🧹 — очистить все введённые количества"
                         Margin="0 0 0 4"/>
              <TextBlock Text="🔢 — включить/выключить сенсорный ввод"
                         Margin="0 0 0 4"/>
              <TextBlock Text="⌫ — удалить последнюю цифру в циферблате"
                         Margin="0 0 0 4"/>
              <TextBlock Text="✓ — подтвердить введённое число"
                         Margin="0 0 0 4"/>
            </StackPanel>
          </StackPanel>
        </ScrollViewer>
      </TabItem>
    </TabControl>

    <!-- ========= POPUP NUMPAD ========= -->
    <Popup x:Name="NumpadPopup" AllowsTransparency="True" StaysOpen="True" Placement="Center">
      <Border CornerRadius="10" Padding="12" Background="White"
              BorderBrush="{StaticResource DataGridBorderBrush}" BorderThickness="1">
        <Border.Effect>
          <DropShadowEffect BlurRadius="10" ShadowDepth="0" Opacity="0.35"/>
        </Border.Effect>
        <Border.RenderTransform>
          <ScaleTransform ScaleX="0.8" ScaleY="0.8"/>
        </Border.RenderTransform>

        <StackPanel>
          <Border Background="{StaticResource DataGridAlternationRowBackgroundBrush}"
                  CornerRadius="8" Padding="6" Margin="0 0 0 12">
            <TextBlock x:Name="NumpadDisplay" FontSize="26" FontWeight="Bold"
                       HorizontalAlignment="Center"/>
          </Border>

          <UniformGrid Columns="3" Rows="4" HorizontalAlignment="Center">
            <Button Style="{StaticResource NumpadButton}" Content="1" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="2" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="3" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="4" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="5" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="6" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="7" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="8" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="9" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="⌫" Click="Numpad_OnBackspace"/>
            <Button Style="{StaticResource NumpadButton}" Content="0" Click="Numpad_OnDigit"/>
            <Button Style="{StaticResource NumpadButton}" Content="✓" Click="Numpad_OnEnter"/>
          </UniformGrid>
        </StackPanel>
      </Border>
    </Popup>
  </Grid>
</Window>